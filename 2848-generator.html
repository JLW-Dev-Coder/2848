<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form 2848 Generator (Stamp)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 28px; line-height: 1.45; }
    h1 { margin: 0 0 6px; }
    .meta { color: #555; font-size: 12px; margin: 0 0 18px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 14px; }
    .pill { background: #f3f4f6; border-radius: 999px; font-size: 12px; max-width: 100%; overflow: hidden; padding: 6px 10px; text-overflow: ellipsis; white-space: nowrap; }
    .btn { cursor: pointer; padding: 10px 14px; }
    #status { margin-top: 14px; font-size: 14px; }
  </style>
</head>
<body>
  <h2 style="color:red">RUNNING BUILD XYZ</h2>

  <h1>Form 2848 Generator</h1>
  <p class="meta" id="buildMeta">Stamped onto a flattened IRS PDF (no form fields required).</p>

  <div class="row" id="summary"></div>

  <div class="row">
    <button class="btn" id="generate" type="button">Generate PDF</button>
  </div>

  <div id="status">Ready.</div>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    (function () {
      const { PDFDocument, rgb, StandardFonts } = PDFLib;

      const BUILD_ID = "2848-align-2026-01-22-f";

      const qs = new URLSearchParams(window.location.search);

      function clean(v) {
        const s = String(v == null ? "" : v).trim();
        if (!s) return "";
        if (s.startsWith("{{") && s.endsWith("}}")) return "";
        return s;
      }

      function get(k) { return clean(qs.get(k)); }
      function getBool(k) { return ["1","true","yes","on"].includes((qs.get(k)||"").toLowerCase()); }

      function formatTin(v) {
        const digits = String(v || "").replace(/\D/g, "");
        if (digits.length === 9) {
          return `${digits.slice(0,3)}-${digits.slice(3,5)}-${digits.slice(5)}`;
        }
        return String(v || "").trim();
      }

      const DEBUG = {
        grid: get("grid") === "1",
        gridStep: Number(get("gridStep") || 50),
        labels: get("labels") === "1",
        ox: Number(get("ox") || 0),
        oy: Number(get("oy") || 0),
        stamp: get("stamp") === "1"
      };

      const V = get("v") || String(Date.now());

      document.getElementById("buildMeta").textContent =
        `Stamped onto a flattened IRS PDF (no form fields required). BUILD=${BUILD_ID}`;

      const data = {
        TaxpayerSSNITIN: get("TaxpayerSSNITIN"),

        clientFirstName: get("clientFirstName"),
        clientLastName: get("clientLastName"),
        clientAddressLine1: get("clientAddressLine1"),
        clientAddressLine2: get("clientAddressLine2"),
        clientAddressTown: get("clientAddressTown"),
        clientAddressRegion: get("clientAddressRegion"),
        clientAddressZip: get("clientAddressZip"),

        line3DescriptionOfMatter:
          get("line3DescriptionOfMatter") ||
          "Income, Employment, Payroll, Excise, Estate, Gift, Civil Penalty, Sec. 4980H Shared Responsibility Payment",

        line3TaxFormNumber: get("line3TaxFormNumber") || "940, 941, 720, 1040, 1120, 1120S",

        line5aAccessRecords: getBool("line5aAccessRecords") || true,
        line5aAuthorizeDisclosure: getBool("line5aAuthorizeDisclosure") || false,
        line5aSignReturn: getBool("line5aSignReturn") || false,
        line5aSubstituteOrAddRep: getBool("line5aSubstituteOrAddRep") || true,

        repFirst: get("2848Rep1FirstName") || get("2848_Rep_1_First_Name"),
        repLast:  get("2848Rep1LastName")  || get("2848_Rep_1_Last_Name"),
        repAddr1: get("2848Rep1AddressLine1") || get("2848_Rep_1_Address_Line_1"),
        repAddr2: get("2848Rep1AddressLine2") || get("2848_Rep_1_Address_Line_2"),
        repCity:  get("2848Rep1AddressCity")  || get("2848_Rep_1_Address_City"),
        repState: get("2848Rep1AddressState") || get("2848_Rep_1_Address_State"),
        repZip:   get("2848Rep1AddressZip")   || get("2848_Rep_1_Address_Zip"),
        repCAF:   get("2848Rep1CAF")          || get("2848_Rep_1_CAF"),
        repPTIN:  get("2848Rep1PTIN")         || get("2848_Rep_1_PTIN"),
        repTel:   get("2848Rep1Telephone")    || get("2848_Rep_1_Telephone"),
        repFax:   get("2848Rep1Fax")          || get("2848_Rep_1_Fax"),

        yearFrom: get("myOrganizationIRSCurrentTaxYear10ComplianceYears"),
        yearTo:   get("myOrganizationIRSCurrentTaxYear")
      };

      const IRS_TEXT_SIZE = 8.5;

      const POS = {
        taxpayerNameAddressBlock: { x: 40, y: 640, lineGap: 9, size: IRS_TEXT_SIZE },
        taxpayerTIN: { x: 348, y: 640, size: IRS_TEXT_SIZE },
        repBlock: { x: 40, y: 565, lineGap: 11, size: IRS_TEXT_SIZE }
      };

      const taxpayerName = [data.clientFirstName, data.clientLastName].filter(Boolean).join(" ");
      const taxpayerAddr12 = [data.clientAddressLine1, data.clientAddressLine2].filter(Boolean).join(" ");
      const taxpayerCityStateZip =
        [data.clientAddressTown, data.clientAddressRegion].filter(Boolean).join(", ") +
        (data.clientAddressZip ? " " + data.clientAddressZip : "");

      const taxpayerNameAddress = [
        taxpayerName,
        taxpayerAddr12,
        taxpayerCityStateZip
      ].filter(Boolean).join("\n");

      const repName = [data.repFirst, data.repLast].filter(Boolean).join(" ");
      const repAddr12 = [data.repAddr1, data.repAddr2].filter(Boolean).join(" ");
      const repCityStateZip =
        [data.repCity, data.repState].filter(Boolean).join(", ") +
        (data.repZip ? " " + data.repZip : "");

      const repBlockText = [
        repName,
        repAddr12,
        repCityStateZip
      ].filter(Boolean).join("\n");

      function ax(x){ return x + DEBUG.ox; }
      function ay(y){ return y + DEBUG.oy; }

      function drawMultiline(page, text, x, y, size, gap, font) {
        let cy = y;
        text.split("\n").forEach(line => {
          page.drawText(line, { x, y: cy, size, font, color: rgb(0,0,0) });
          cy -= gap;
        });
      }

      async function generate() {
        status.textContent = "Generating PDFâ€¦";

        const res = await fetch(`./f2848.pdf?v=${encodeURIComponent(V)}`, { cache: "no-store" });
        if (!res.ok) throw new Error("PDF fetch failed");
        const pdfBytes = await res.arrayBuffer();

        const pdfDoc = await PDFDocument.load(pdfBytes);
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const page1 = pdfDoc.getPages()[0];

        drawMultiline(
          page1,
          taxpayerNameAddress,
          ax(POS.taxpayerNameAddressBlock.x),
          ay(POS.taxpayerNameAddressBlock.y),
          POS.taxpayerNameAddressBlock.size,
          POS.taxpayerNameAddressBlock.lineGap,
          font
        );

        page1.drawText(formatTin(data.TaxpayerSSNITIN), {
          x: ax(POS.taxpayerTIN.x),
          y: ay(POS.taxpayerTIN.y),
          size: POS.taxpayerTIN.size,
          font,
          color: rgb(0,0,0)
        });

        drawMultiline(
          page1,
          repBlockText,
          ax(POS.repBlock.x),
          ay(POS.repBlock.y),
          POS.repBlock.size,
          POS.repBlock.lineGap,
          font
        );

        const out = await pdfDoc.save();
        const blob = new Blob([out], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "Form-2848-filled.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        status.textContent = "PDF generated.";
      }

      document.getElementById("generate").addEventListener("click", () => {
        generate().catch(e => {
          console.error(e);
          status.textContent = "Error generating PDF.";
        });
      });
    })();
  </script>
</body>
</html>
