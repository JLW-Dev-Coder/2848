<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Form 2848 Generator (Stamp)</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 28px; line-height: 1.45; }
    h1 { margin: 0 0 6px; }
    .meta { color: #555; font-size: 14px; margin: 0 0 18px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px; margin: 0 0 14px; }
    .pill { background: #f3f4f6; border-radius: 999px; font-size: 12px; max-width: 100%; overflow: hidden; padding: 6px 10px; text-overflow: ellipsis; white-space: nowrap; }
    .btn { cursor: pointer; padding: 10px 14px; }
    #status { margin-top: 14px; font-size: 14px; }
  </style>
</head>
<body>

  <h1>Form 2848 Generator</h1>
  <p class="meta">Stamped onto a flattened IRS PDF (no form fields required).</p>

  <div class="row" id="summary"></div>

  <div class="row">
    <button class="btn" id="generate" type="button">Generate PDF</button>
  </div>

  <div id="status">Ready.</div>

  <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script>
    (function () {
      const { PDFDocument, rgb, StandardFonts } = PDFLib;

      const qs = new URLSearchParams(window.location.search);
      const get = (k) => (qs.get(k) || "").trim();
      const getBool = (k) => ["1", "true", "yes", "on"].includes((qs.get(k) || "").toLowerCase());

      const DEBUG = {
        grid: get("grid") === "1",
        gridStep: Number(get("gridStep") || 50),
        labels: get("labels") === "1",
        ox: Number(get("ox") || 0),
        oy: Number(get("oy") || 0)
      };

      const data = {
        TaxpayerSSNITIN: get("TaxpayerSSNITIN") || "{{TaxpayerSSNITIN}}",
        clientAddressLine1: get("clientAddressLine1") || "{{clientAddressLine1}}",
        clientAddressLine2: get("clientAddressLine2") || "{{clientAddressLine2}}",
        clientAddressRegion: get("clientAddressRegion") || "{{clientAddressRegion}}",
        clientAddressTown: get("clientAddressTown") || "{{clientAddressTown}}",
        clientAddressZip: get("clientAddressZip") || "{{clientAddressZip}}",
        clientFirstName: get("clientFirstName") || "{{clientFirstName}}",
        clientLastName: get("clientLastName") || "{{clientLastName}}",

        line3DescriptionOfMatter: get("line3DescriptionOfMatter") || "Income Tax",
        line3TaxFormNumber: get("line3TaxFormNumber") || "1040",

        line5aAccessRecords: getBool("line5aAccessRecords") || true,
        line5aAuthorizeDisclosure: getBool("line5aAuthorizeDisclosure") || false,
        line5aSignReturn: getBool("line5aSignReturn") || false,
        line5aSubstituteOrAddRep: getBool("line5aSubstituteOrAddRep") || true,

        repAddr1: get("2848_Rep_1_Address_Line_1") || "{{2848_Rep_1_Address_Line_1}}",
        repAddr2: get("2848_Rep_1_Address_Line_2") || "{{2848_Rep_1_Address_Line_2}}",
        repCAF: get("2848_Rep_1_CAF") || "{{2848_Rep_1_CAF}}",
        repCity: get("2848_Rep_1_Address_City") || "{{2848_Rep_1_Address_City}}",
        repFax: get("2848_Rep_1_Fax") || "{{2848_Rep_1_Fax}}",
        repFirst: get("2848_Rep_1_First_Name") || "{{2848_Rep_1_First_Name}}",
        repLast: get("2848_Rep_1_Last_Name") || "{{2848_Rep_1_Last_Name}}",
        repPTIN: get("2848_Rep_1_PTIN") || "{{2848_Rep_1_PTIN}}",
        repState: get("2848_Rep_1_Address_State") || "{{2848_Rep_1_Address_State}}",
        repTel: get("2848_Rep_1_Telephone") || "{{2848_Rep_1_Telephone}}",
        repZip: get("2848_Rep_1_Address_Zip") || "{{2848_Rep_1_Address_Zip}}",

        yearFrom: get("myOrganizationIRSCurrentTaxYear10ComplianceYears") || "{{myOrganizationIRSCurrentTaxYear10ComplianceYears}}",
        yearTo: get("myOrganizationIRSCurrentTaxYear") || "{{myOrganizationIRSCurrentTaxYear}}"
      };

      const POS = {
        acts_desc_1: { x: 40,  y: 270, size: 9 },
        acts_desc_2: { x: 40,  y: 245, size: 9 },
        acts_desc_3: { x: 40,  y: 220, size: 9 },

        acts_form_1: { x: 330, y: 270, size: 9 },
        acts_form_2: { x: 330, y: 245, size: 9 },
        acts_form_3: { x: 330, y: 220, size: 9 },

        acts_year_1: { x: 450, y: 270, size: 9 },
        acts_year_2: { x: 450, y: 245, size: 9 },
        acts_year_3: { x: 450, y: 220, size: 9 },

        line5aAccessISP_Check:           { x: 210, y: 130 },
        line5aAuthorizeDisclosure_Check: { x: 55,  y: 130 },
        line5aSignReturn_Check:          { x: 560, y: 130 },
        line5aSubAddRep_Check:           { x: 410, y: 130 },

        repBlock: { x: 50, y: 515, lineGap: 11, size: 9 },

        repCAF:  { x: 405, y: 540, size: 9 },
        repPTIN: { x: 405, y: 525, size: 9 },
        repTel:  { x: 405, y: 510, size: 9 },
        repFax:  { x: 405, y: 495, size: 9 },

        taxpayerNameAddressBlock: { x: 50, y: 0, lineGap: 11, size: 9 },
        taxpayerTIN: { x: 400, y: 650, size: 9 }
      };

      const status = document.getElementById("status");
      const summary = document.getElementById("summary");

      const pill = (label, value) => {
        const d = document.createElement("div");
        d.className = "pill";
        d.textContent = value ? `${label}: ${value}` : `${label}: (blank)`;
        summary.appendChild(d);
      };

      const clamp = (s, n) => (s || "").length > n ? (s || "").slice(0, n - 1) + "…" : (s || "");
      const join = (arr) => arr.map(v => (v || "").trim()).filter(Boolean).join("\n");

      const taxpayerName = [data.clientFirstName, data.clientLastName].filter(Boolean).join(" ").trim();
      const repName = [data.repFirst, data.repLast].filter(Boolean).join(" ").trim();
      const yearRange = (data.yearFrom && data.yearTo) ? `${data.yearFrom} through ${data.yearTo}` : (data.yearFrom || data.yearTo || "");

      const repAddress = join([
        data.repAddr1,
        data.repAddr2,
        [data.repCity, data.repState].filter(Boolean).join(", ") + (data.repZip ? " " + data.repZip : "")
      ]);

      const taxpayerNameAddress = join([
        taxpayerName,
        data.clientAddressLine1,
        data.clientAddressLine2,
        [data.clientAddressTown, data.clientAddressRegion].filter(Boolean).join(", ") + (data.clientAddressZip ? " " + data.clientAddressZip : "")
      ]);

      pill("Matter", data.line3DescriptionOfMatter);
      pill("Representative", repName);
      pill("Tax form", data.line3TaxFormNumber);
      pill("Taxpayer", taxpayerName);

      function ax(x) { return x + DEBUG.ox; }
      function ay(y) { return y + DEBUG.oy; }

      function drawMultiline(page, text, x, y, size, lineGap, font) {
        const lines = (text || "").split("\n").map(s => s.trim()).filter(Boolean);
        let cy = y;
        for (const line of lines) {
          page.drawText(line, { x, y: cy, size, font, color: rgb(0, 0, 0) });
          cy -= lineGap;
        }
      }

      function drawCheck(page, x, y, font) {
        page.drawText("X", { x: x + 1, y: y - 3, size: 8, font, color: rgb(0, 0, 0) });
      }

      function drawCrosshair(page, x, y) {
        const len = 8;
        page.drawLine({ start: { x: x - len, y }, end: { x: x + len, y }, thickness: 0.75, color: rgb(1, 0, 0) });
        page.drawLine({ start: { x, y: y - len }, end: { x, y: y + len }, thickness: 0.75, color: rgb(1, 0, 0) });
      }

      function drawGrid(page, font, width, height, step) {
        const thin = 0.4;
        const thick = 0.9;

        for (let x = 0; x <= width; x += step) {
          const isMajor = (x % (step * 2) === 0);
          page.drawLine({
            start: { x, y: 0 },
            end: { x, y: height },
            thickness: isMajor ? thick : thin,
            color: rgb(0.75, 0.75, 0.75)
          });
          page.drawText(String(x), { x: Math.min(x + 2, width - 18), y: height - 12, size: 7, font, color: rgb(0.35, 0.35, 0.35) });
        }

        for (let y = 0; y <= height; y += step) {
          const isMajor = (y % (step * 2) === 0);
          page.drawLine({
            start: { x: 0, y },
            end: { x: width, y },
            thickness: isMajor ? thick : thin,
            color: rgb(0.75, 0.75, 0.75)
          });
          page.drawText(String(y), { x: 2, y: Math.min(y + 2, height - 10), size: 7, font, color: rgb(0.35, 0.35, 0.35) });
        }

        page.drawText(`GRID step=${step}  ox=${DEBUG.ox}  oy=${DEBUG.oy}`, { x: 12, y: height - 26, size: 9, font, color: rgb(0.2, 0.2, 0.2) });
      }

      function drawAnchorLabels(page, font) {
        const anchors = [
          ["acts_desc_1", POS.acts_desc_1.x, POS.acts_desc_1.y],
          ["acts_form_1", POS.acts_form_1.x, POS.acts_form_1.y],
          ["acts_year_1", POS.acts_year_1.x, POS.acts_year_1.y],
          ["line5aAccessISP_Check", POS.line5aAccessISP_Check.x, POS.line5aAccessISP_Check.y],
          ["repBlock", POS.repBlock.x, POS.repBlock.y],
          ["repCAF", POS.repCAF.x, POS.repCAF.y],
          ["repFax", POS.repFax.x, POS.repFax.y],
          ["repPTIN", POS.repPTIN.x, POS.repPTIN.y],
          ["repTel", POS.repTel.x, POS.repTel.y],
          ["taxpayerNameAddressBlock", POS.taxpayerNameAddressBlock.x, POS.taxpayerNameAddressBlock.y],
          ["taxpayerTIN", POS.taxpayerTIN.x, POS.taxpayerTIN.y]
        ];

        anchors.forEach(([name, x, y]) => {
          const px = ax(x);
          const py = ay(y);
          drawCrosshair(page, px, py);
          page.drawText(`${name} (${x},${y})`, { x: px + 10, y: py + 2, size: 7, font, color: rgb(1, 0, 0) });
        });
      }

      async function generate() {
        status.textContent = "Generating PDF…";

        const res = await fetch("./f2848.pdf");
        if (!res.ok) throw new Error(`PDF fetch failed: ${res.status} ${res.statusText}`);
        const pdfBytes = await res.arrayBuffer();

        const pdfDoc = await PDFDocument.load(pdfBytes);
        const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
        const page1 = pdfDoc.getPages()[0];

        const { width, height } = page1.getSize();
        page1.setCropBox(0, 0, width, height);

        if (DEBUG.grid) drawGrid(page1, font, width, height, DEBUG.gridStep);
        if (DEBUG.labels) drawAnchorLabels(page1, font);

        drawMultiline(
          page1,
          taxpayerNameAddress,
          ax(POS.taxpayerNameAddressBlock.x),
          ay(POS.taxpayerNameAddressBlock.y),
          POS.taxpayerNameAddressBlock.size,
          POS.taxpayerNameAddressBlock.lineGap,
          font
        );

        page1.drawText((data.TaxpayerSSNITIN || "").trim(), {
          x: ax(POS.taxpayerTIN.x),
          y: ay(POS.taxpayerTIN.y),
          size: POS.taxpayerTIN.size,
          font,
          color: rgb(0, 0, 0)
        });

        drawMultiline(
          page1,
          join([repName, repAddress]),
          ax(POS.repBlock.x),
          ay(POS.repBlock.y),
          POS.repBlock.size,
          POS.repBlock.lineGap,
          font
        );

        page1.drawText((data.repCAF || "").trim(),  { x: ax(POS.repCAF.x),  y: ay(POS.repCAF.y),  size: POS.repCAF.size,  font, color: rgb(0, 0, 0) });
        page1.drawText((data.repPTIN || "").trim(), { x: ax(POS.repPTIN.x), y: ay(POS.repPTIN.y), size: POS.repPTIN.size, font, color: rgb(0, 0, 0) });
        page1.drawText((data.repTel || "").trim(),  { x: ax(POS.repTel.x),  y: ay(POS.repTel.y),  size: POS.repTel.size,  font, color: rgb(0, 0, 0) });
        page1.drawText((data.repFax || "").trim(),  { x: ax(POS.repFax.x),  y: ay(POS.repFax.y),  size: POS.repFax.size,  font, color: rgb(0, 0, 0) });

        const acts = [
          { desc: (data.line3DescriptionOfMatter || "").trim(), form: (data.line3TaxFormNumber || "").trim(), years: yearRange },
          { desc: "", form: "", years: "" },
          { desc: "", form: "", years: "" }
        ];

        acts.forEach((row, i) => {
          const idx = i + 1;
          page1.drawText(clamp(row.desc, 75), {
            x: ax(POS[`acts_desc_${idx}`].x),
            y: ay(POS[`acts_desc_${idx}`].y),
            size: POS[`acts_desc_${idx}`].size,
            font,
            color: rgb(0, 0, 0)
          });

          page1.drawText(clamp(row.form, 12), {
            x: ax(POS[`acts_form_${idx}`].x),
            y: ay(POS[`acts_form_${idx}`].y),
            size: POS[`acts_form_${idx}`].size,
            font,
            color: rgb(0, 0, 0)
          });

          page1.drawText(clamp(row.years, 22), {
            x: ax(POS[`acts_year_${idx}`].x),
            y: ay(POS[`acts_year_${idx}`].y),
            size: POS[`acts_year_${idx}`].size,
            font,
            color: rgb(0, 0, 0)
          });
        });

        if (data.line5aAuthorizeDisclosure) drawCheck(page1, ax(POS.line5aAuthorizeDisclosure_Check.x), ay(POS.line5aAuthorizeDisclosure_Check.y), font);
        if (data.line5aAccessRecords)      drawCheck(page1, ax(POS.line5aAccessISP_Check.x),          ay(POS.line5aAccessISP_Check.y),          font);
        if (data.line5aSubstituteOrAddRep) drawCheck(page1, ax(POS.line5aSubAddRep_Check.x),          ay(POS.line5aSubAddRep_Check.y),          font);
        if (data.line5aSignReturn)         drawCheck(page1, ax(POS.line5aSignReturn_Check.x),         ay(POS.line5aSignReturn_Check.y),         font);

        const out = await pdfDoc.save();
        const blob = new Blob([out], { type: "application/pdf" });
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = "Form-2848-filled.pdf";
        document.body.appendChild(a);
        a.click();
        a.remove();

        URL.revokeObjectURL(url);
        status.textContent = "PDF generated.";
      }

      document.getElementById("generate").addEventListener("click", () => {
        generate().catch((e) => {
          console.error(e);
          status.textContent = `Error: ${e && e.message ? e.message : String(e)}`;
        });
      });
    })();
  </script>
</body>
</html>
